#!/usr/bin/env Rscript

message("Checking for node / npm")
if (Sys.which("npm")[["npm"]] == "") {
  stop("Please install node / npm before running script")
}

versions <- list()

# Use local lib path for installing packages so we don't pollute the user's library
message("Installing GitHub packages: bslib, shiny, htmltools")
withr::local_temp_libpaths()
ignore <- capture.output({
  pak::pkg_install(c("rstudio/bslib@main", "rstudio/shiny@main", "rstudio/htmltools@main"))
})
# pak::pkg_install(c("cran::bslib", "cran::shiny", "cran::htmltools"))

versions["shiny_html_deps"] <- as.character(packageVersion("shiny"))
versions["bslib"] <- as.character(packageVersion("bslib"))
versions["htmltools"] <- as.character(packageVersion("htmltools"))

pkg_source_version <- function(pkg_name) {
  pkg_info <- sessioninfo::package_info(pkg_name)
  pkg_info_list <- pkg_info[pkg_info$package == pkg_name, , drop = TRUE]
  pkg_info_list$source
}
write_json <- function(file, x, ..., pretty = TRUE, auto_unbox = TRUE) {
  jsonlite::write_json(
    c(
      list("note!" = "This file is auto-generated by scripts/htmlDependencies.R"),
      x
    ),
    file,
    ...,
    pretty = pretty, auto_unbox = auto_unbox
  )

}

bslib_version <- pkg_source_version("bslib")
shiny_version <- pkg_source_version("shiny")
htmltools_version <- pkg_source_version("htmltools")

library(htmltools, quietly = TRUE, warn.conflicts = FALSE)
library(bslib, quietly = TRUE, warn.conflicts = FALSE)

shiny_path <- fs::path(getwd(), "shiny")
www <- fs::path(shiny_path, "www")
www_shared <- fs::path(www, "shared")

x_www <- fs::path(shiny_path, "experimental", "www")
x_www_bslib_components <- fs::path(x_www, "bslib", "components")
x_www_htmltools_fill <- fs::path(x_www, "htmltools", "fill")
main_x_www <- fs::path(www_shared, "_x")

# Copy over shiny's www/shared directory
copy_from_pkg <- function(pkg_name, pkg_dir, local_dir, version_dir = fs::path_dir(local_dir)) {
  # `version_dir` is "equal to" or "contains" `local_dir`
  stopifnot(fs::path_has_parent(local_dir, version_dir))
  if (fs::dir_exists(version_dir)) fs::dir_delete(version_dir)
  fs::dir_create(local_dir)

  stopifnot(local_dir != ".")

  # Copy other folder into local parent folder
  fs::dir_copy(
    system.file(pkg_dir, package = pkg_name),
    dirname(local_dir)
  )
  # Rename folder to local folder name
  if (basename(local_dir) != basename(pkg_dir)) {
    file.rename(
      fs::path(dirname(local_dir), basename(pkg_dir)),
      local_dir
    )
  }
  # Save pkg version info
  write_json(
    fs::path(version_dir, "_version.json"),
    list(
      package = pkg_name,
      version = pkg_source_version(pkg_name)
    )
  )
}


# ------------------------------------------------------------------------------
message("Copy bslib components")
# Copy over bslib's components directory
copy_from_pkg("bslib", "components/dist", x_www_bslib_components)
# Remove non-minified files
fs::file_delete(
  fs::dir_ls(
    x_www_bslib_components,
    type = "file",
    recurse = TRUE,
    regexp = "\\.(min\\.|css)",
    invert = TRUE
  )
)


# ------------------------------------------------------------------------------
message("Copy htmltools - fill")
# Copy over htmltools's fill directory
copy_from_pkg("htmltools", "fill", fs::path(x_www, "htmltools", "fill"))


# ------------------------------------------------------------------------------
message("Copy shiny www/shared")
# Copy over shiny's www/shared directory
copy_from_pkg("shiny", "www/shared", www_shared, www_shared)


# ------------------------------------------------------------------------------
message("Cleanup shiny www/shared")
# Don't need legacy (hopefully)
fs::dir_delete(fs::path(www_shared, "legacy"))
# Don't need dataTables (hopefully)
fs::dir_delete(fs::path(www_shared, "datatables"))

# jQuery will come in via bslib (below)
fs::file_delete(
  fs::dir_ls(www_shared, type = "file", regexp = "jquery")
)


# ------------------------------------------------------------------------------
message("Save ionRangeSlider dep")

# Upgrade to Bootstrap 5 by default
shiny_theme <- bslib::bs_theme(version = 5, preset = "shiny")
# Save iorange slider dep
# Get _dynamic_ ionrangeslider dep
ion_dep <- shiny:::ionRangeSliderDependencyCSS(shiny_theme)
if (inherits(ion_dep, "html_dependency")) {
  ion_dep <- list(ion_dep)
}
# Save to temp folder
temp_ion_dep_dir <- fs::path_temp("shiny-ion-range-slider")
fs::dir_create(temp_ion_dep_dir)
withr::with_options(
  list(htmltools.dir.version = FALSE),
  ignore <- lapply(ion_dep, htmltools::copyDependencyToDir, temp_ion_dep_dir)
)
# Overwrite css file
ion_dep_dir <- fs::path(www_shared, "ionrangeslider")
fs::file_move(
  fs::path(temp_ion_dep_dir, "ionRangeSlider", "ionRangeSlider.css"),
  fs::path(ion_dep_dir, "css", "ion.rangeSlider.css")
)
# Cleanup
fs::dir_delete(temp_ion_dep_dir)

# TODO - make a UI object and save its dependencies. Loop through the different UI elements of bslib and save them accordingly. Similar to shiny::input_slider? instead of reaching into the `:::`


message("Save bootstrap bundle")
# Save htmldeps
deps <- bslib::bs_theme_dependencies(shiny_theme)
withr::with_options(
  list(htmltools.dir.version = FALSE),
  ignore <- lapply(deps, copyDependencyToDir, www_shared)
)
bs_ver <- names(bslib::versions())[bslib::versions() == "5"]
versions["bootstrap"] <- bs_ver
write_json(
  "shiny/www/shared/bootstrap/_version.json",
  list(
    shiny_version = shiny_version,
    bslib_version = bslib_version,
    htmltools_version = htmltools_version,
    bootstrap_version = bs_ver
  )
)

message("Reduce font files")
font_txt <- unlist(strsplit(readLines("shiny/www/shared/bootstrap/font.css"), ";"))
woff_files <- list.files("shiny/www/shared/bootstrap/fonts", pattern = "\\.woff", full.names = TRUE)
ignored <- lapply(woff_files, function(woff_file) {
  file_name <- basename(woff_file)
  if (!any(grepl(file_name, font_txt, fixed = TRUE))) {
    unlink(woff_file)
  }
})


# ------------------------------------------------------------------------------
message("Cleanup bootstrap bundle")
# This additional bs3compat HTMLDependency() only holds
# the JS shim for tab panel logic, which we don't need
# since we're generating BS5+ tab markup. Note, however,
# we still do have bs3compat's CSS on the page, which
# comes in via the bootstrap HTMLDependency()
fs::dir_delete(fs::path(www_shared, "bs3compat"))


# ------------------------------------------------------------------------------
message("Save requirejs")
requirejs_version <- "2.3.6"
versions["requirejs"] <- requirejs_version
requirejs <- fs::path(www_shared, "requirejs")
fs::dir_create(requirejs)
download.file(
  paste0("https://cdnjs.cloudflare.com/ajax/libs/require.js/", requirejs_version, "/require.min.js"),
  fs::path(requirejs, "require.min.js"),
  quiet = TRUE
)

shims <- fs::path(getwd(), "scripts", "define-shims.js")

cat(
  "\n\n",
  paste(readLines(shims), collapse = "\n"),
  file = fs::path(requirejs, "require.min.js"),
  append = TRUE
)


# ------------------------------------------------------------------------------
message("Save _versions.py")
version_vars <- paste0(names(versions), " = ", "\"", versions, "\"\n", collapse = "")
version_all <- paste0(
  collapse = "",
  "__all__ = (\n",
  paste0("    \"", names(versions), "\",\n", collapse = ""),
  ")\n"
)
cat(
  file = fs::path(shiny_path, "_versions.py"),
  version_vars,
  "\n",
  version_all,
  sep = ""
)


# ------------------------------------------------------------------------------
message("Copy www/shared/_x assets")

if (fs::dir_exists(main_x_www)) fs::dir_delete(main_x_www)

main_x_bslib_components <- fs::path(main_x_www, "bslib")
main_x_htmltools_fill <- fs::path(main_x_www, "htmltools")
fs::dir_create(c(main_x_bslib_components, main_x_htmltools_fill))

# Copy bslib
fs::dir_copy(x_www_bslib_components, main_x_bslib_components)
# Copy htmltools
fs::dir_copy(x_www_htmltools_fill, main_x_htmltools_fill)
# Remove unused files
fs::file_delete(
  fs::dir_ls(
    fs::path(main_x_bslib_components, "components"),
    regexp="(_version|sidebar|nav_spacer)",
    invert = TRUE
  )
)


# ------------------------------------------------------------------------------
message("Create dataframe.js via npm")

js_path <- fs::path_abs(fs::path(shiny_path, "..", "js"))
ignore <- system(
  paste0("cd ", js_path, " && npm install && npm run build"),
  intern = TRUE
)
